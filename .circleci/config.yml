version: 2.1

orbs:
  docker: circleci/docker@1.4.0

workflows:
  build-and-deploy:
    jobs:
      - docker/publish:
          image: $DOCKER_IMAGE_NAME
          deploy: false
      - deploy-to-heroku:
          requires: 
            - docker/publish

jobs:
  deploy-to-heroku:
    machine: true
    steps:
      - run: |
            heroku auth:whoami
            heroku container:login
            docker tag $DOCKER_IMAGE_NAME registry.heroku.com/$HEROKU_APP_NAME/web
            heroku container:push -a $HEROKU_APP_NAME
            heroku container:release -a $HEROKU_APP_NAME
